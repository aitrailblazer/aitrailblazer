name: Azure Deployment

on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      # Azure AD Credentials
      AZUREAD__CLIENTID: ${{ secrets.AZUREAD__CLIENTID }}
      AZUREAD__CLIENTSECRET: ${{ secrets.AZUREAD__CLIENTSECRET }}
      AZUREAD__TENANTID: ${{ secrets.AZUREAD__TENANTID }}
      AZUREAD__DOMAIN: ${{ secrets.AZUREAD__DOMAIN }}
      AZUREAD__INSTANCE: ${{ secrets.AZUREAD__INSTANCE }}
      AZUREAD__CALLBACKPATH: ${{ secrets.AZUREAD__CALLBACKPATH }}
      
      # Downstream API
      DOWNSTREAMAPI__BASEURL: ${{ secrets.DOWNSTREAMAPI__BASEURL }}
      DOWNSTREAMAPI__SCOPES: ${{ secrets.DOWNSTREAMAPI__SCOPES }}
      
      # Azure OpenAI
      AZUREOPENAIENDPOINT03: ${{ secrets.AZUREOPENAIENDPOINT03 }}
      AZUREOPENAIKEY03: ${{ secrets.AZUREOPENAIKEY03 }}
      AZUREOPENAIMODELNAME02: ${{ secrets.AZUREOPENAIMODELNAME02 }}
      AZUREOPENAIMODELNAME03: ${{ secrets.AZUREOPENAIMODELNAME03 }}
      
      # Azure Container Apps
      AZURE_CONTAINER_APPS_ENVIRONMENT_NAME: ${{ secrets.AZURE_CONTAINER_APPS_ENVIRONMENT_NAME }}
      AZURE_CONTAINER_APPS_ENVIRONMENT_DEFAULT_DOMAIN: ${{ secrets.AZURE_CONTAINER_APPS_ENVIRONMENT_DEFAULT_DOMAIN }}
      AZURE_CONTAINER_APPS_ENVIRONMENT_ID: ${{ secrets.AZURE_CONTAINER_APPS_ENVIRONMENT_ID }}
      AZURE_CONTAINER_REGISTRY_ENDPOINT: ${{ secrets.AZURE_CONTAINER_REGISTRY_ENDPOINT }}
      AZURE_CONTAINER_REGISTRY_MANAGED_IDENTITY_ID: ${{ secrets.AZURE_CONTAINER_REGISTRY_MANAGED_IDENTITY_ID }}
      
      # Azure Environment
      AZURE_ENV_NAME: ${{ secrets.AZURE_ENV_NAME }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_LOCATION: eastus2
      
      # Azure Log Analytics
      AZURE_LOG_ANALYTICS_WORKSPACE_NAME: ${{ secrets.AZURE_LOG_ANALYTICS_WORKSPACE_NAME }}
      
      # Managed Identity
      MANAGED_IDENTITY_CLIENT_ID: ${{ secrets.MANAGED_IDENTITY_CLIENT_ID }}
      MANAGED_IDENTITY_NAME: ${{ secrets.MANAGED_IDENTITY_NAME }}
      
      # Container Registry Credentials
      REGISTRY_USERNAME: ${{ secrets.WEBFRONTEND_REGISTRY_USERNAME }}
      REGISTRY_PASSWORD: ${{ secrets.WEBFRONTEND_REGISTRY_PASSWORD }}
      
      # Other Services
      BING_API_KEY: ${{ secrets.BING_API_KEY }}
      GTB_TOKEN: ${{ secrets.GTB_TOKEN }}
      SMARTCOMPONENTS__APIKEY: ${{ secrets.SMARTCOMPONENTS__APIKEY }}
      SMARTCOMPONENTS__DEPLOYMENTNAME: ${{ secrets.SMARTCOMPONENTS__DEPLOYMENTNAME }}
      SMARTCOMPONENTS__ENDPOINT: ${{ secrets.SMARTCOMPONENTS__ENDPOINT }}
      
      # Storage
      STORAGECONNECTIONSTRING: ${{ secrets.STORAGECONNECTIONSTRING }}
      STORAGECONTAINERNAME: ${{ secrets.STORAGECONTAINERNAME }}
      
      # Additional Azure Credentials
      CLIENTID: ${{ secrets.CLIENTID }}
      CLIENTSECRET: ${{ secrets.CLIENTSECRET }}
      TENANTID: ${{ secrets.TENANTID }}
      
      # Webfrontend Azure Credentials
      WEBFRONTEND_AZURE_CLIENT_ID: ${{ secrets.WEBFRONTEND_AZURE_CLIENT_ID }}
      WEBFRONTEND_AZURE_SUBSCRIPTION_ID: ${{ secrets.WEBFRONTEND_AZURE_SUBSCRIPTION_ID }}
      WEBFRONTEND_AZURE_TENANT_ID: ${{ secrets.WEBFRONTEND_AZURE_TENANT_ID }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '9.0.x'

      - name: Install Azure Developer CLI (azd)
        uses: Azure/setup-azd@v1.0.0

      - name: Install .NET Aspire Workload
        run: dotnet workload install aspire

      - name: Log in with Azure (Federated Credentials)
        if: ${{ env.AZUREAD__CLIENTID != '' }}
        run: |
          azd auth login \
            --client-id "${{ env.AZUREAD__CLIENTID }}" \
            --federated-credential-provider "github" \
            --tenant-id "${{ env.AZUREAD__TENANTID }}"
        shell: bash

      - name: Log in with Azure (Client Credentials)
        if: ${{ env.CLIENTSECRET != '' }}
        run: |
          echo "::add-mask::${{ secrets.CLIENTSECRET }}"
          azd auth login \
            --client-id "${{ env.CLIENTID }}" \
            --client-secret "${{ env.CLIENTSECRET }}" \
            --tenant-id "${{ env.TENANTID }}"
        shell: bash

      # Uncomment and configure if needed
      # - name: Provision Infrastructure
      #   run: azd provision --no-prompt

      # - name: Refresh azd environment
      #   run: azd env refresh
      #   env:
      #     AZURE_LOCATION: ${{ env.AZURE_LOCATION }}

      - name: Create azd Environment
        run: |
          cd aitrailblazer.AppHost
          azd env new $AZURE_ENV_NAME --subscription $AZURE_SUBSCRIPTION_ID --location $AZURE_LOCATION --no-prompt
        env:
          AZURE_ENV_NAME: ${{ secrets.AZURE_ENV_NAME }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE_LOCATION: eastus2

      - name: Set Variables in azd Environment
        run: |
          cd aitrailblazer.AppHost
          azd env set AZURE_LOCATION $AZURE_LOCATION
          azd env set AZURE_SUBSCRIPTION_ID $AZURE_SUBSCRIPTION_ID
          azd env set AZURE_CONTAINER_APPS_ENVIRONMENT_NAME $AZURE_CONTAINER_APPS_ENVIRONMENT_NAME
          azd env set AZURE_CONTAINER_APPS_ENVIRONMENT_DEFAULT_DOMAIN $AZURE_CONTAINER_APPS_ENVIRONMENT_DEFAULT_DOMAIN
          azd env set AZURE_CONTAINER_APPS_ENVIRONMENT_ID $AZURE_CONTAINER_APPS_ENVIRONMENT_ID
          azd env set AZURE_CONTAINER_REGISTRY_ENDPOINT $AZURE_CONTAINER_REGISTRY_ENDPOINT
          azd env set AZURE_CONTAINER_REGISTRY_MANAGED_IDENTITY_ID $AZURE_CONTAINER_REGISTRY_MANAGED_IDENTITY_ID
          azd env set AZURE_LOG_ANALYTICS_WORKSPACE_NAME $AZURE_LOG_ANALYTICS_WORKSPACE_NAME
          azd env set MANAGED_IDENTITY_CLIENT_ID $MANAGED_IDENTITY_CLIENT_ID
          azd env set MANAGED_IDENTITY_NAME $MANAGED_IDENTITY_NAME
          # Add other variables as needed
        env:
          AZURE_LOCATION: ${{ secrets.AZURE_LOCATION }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE_CONTAINER_APPS_ENVIRONMENT_NAME: ${{ secrets.AZURE_CONTAINER_APPS_ENVIRONMENT_NAME }}
          AZURE_CONTAINER_APPS_ENVIRONMENT_DEFAULT_DOMAIN: ${{ secrets.AZURE_CONTAINER_APPS_ENVIRONMENT_DEFAULT_DOMAIN }}
          AZURE_CONTAINER_APPS_ENVIRONMENT_ID: ${{ secrets.AZURE_CONTAINER_APPS_ENVIRONMENT_ID }}
          AZURE_CONTAINER_REGISTRY_ENDPOINT: ${{ secrets.AZURE_CONTAINER_REGISTRY_ENDPOINT }}
          AZURE_CONTAINER_REGISTRY_MANAGED_IDENTITY_ID: ${{ secrets.AZURE_CONTAINER_REGISTRY_MANAGED_IDENTITY_ID }}
          AZURE_LOG_ANALYTICS_WORKSPACE_NAME: ${{ secrets.AZURE_LOG_ANALYTICS_WORKSPACE_NAME }}
          MANAGED_IDENTITY_CLIENT_ID: ${{ secrets.MANAGED_IDENTITY_CLIENT_ID }}
          MANAGED_IDENTITY_NAME: ${{ secrets.MANAGED_IDENTITY_NAME }}

      - name: Deploy Application
        run: |
          cd aitrailblazer.AppHost
          azd config set alpha.aca.persistDomains on
          azd deploy --no-prompt
        env:
          # Azure AD Credentials
          AZUREAD__CLIENTID: ${{ secrets.AZUREAD__CLIENTID }}
          AZUREAD__TENANTID: ${{ secrets.AZUREAD__TENANTID }}
          
          # Azure Environment
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE_ENV_NAME: ${{ secrets.AZURE_ENV_NAME }}
          AZURE_LOCATION: eastus2
          AZURE_CONTAINER_APPS_ENVIRONMENT_NAME: ${{ secrets.AZURE_CONTAINER_APPS_ENVIRONMENT_NAME }}
          AZURE_CONTAINER_APPS_ENVIRONMENT_DEFAULT_DOMAIN: ${{ secrets.AZURE_CONTAINER_APPS_ENVIRONMENT_DEFAULT_DOMAIN }}
          AZURE_CONTAINER_APPS_ENVIRONMENT_ID: ${{ secrets.AZURE_CONTAINER_APPS_ENVIRONMENT_ID }}
          AZURE_CONTAINER_REGISTRY_ENDPOINT: ${{ secrets.AZURE_CONTAINER_REGISTRY_ENDPOINT }}
          AZURE_CONTAINER_REGISTRY_MANAGED_IDENTITY_ID: ${{ secrets.AZURE_CONTAINER_REGISTRY_MANAGED_IDENTITY_ID }}
          AZURE_LOG_ANALYTICS_WORKSPACE_NAME: ${{ secrets.AZURE_LOG_ANALYTICS_WORKSPACE_NAME }}
          
          # Managed Identity
          MANAGED_IDENTITY_CLIENT_ID: ${{ secrets.MANAGED_IDENTITY_CLIENT_ID }}
          MANAGED_IDENTITY_NAME: ${{ secrets.MANAGED_IDENTITY_NAME }}
          
          # Container Registry Credentials
          REGISTRY_USERNAME: ${{ secrets.WEBFRONTEND_REGISTRY_USERNAME }}
          REGISTRY_PASSWORD: ${{ secrets.WEBFRONTEND_REGISTRY_PASSWORD }}
          
          # .NET Configuration
          DOTNET_ROOT: /usr/share/dotnet
          
          # Other Services
          BING_API_KEY: ${{ secrets.BING_API_KEY }}
          GTB_TOKEN: ${{ secrets.GTB_TOKEN }}
          SMARTCOMPONENTS__APIKEY: ${{ secrets.SMARTCOMPONENTS__APIKEY }}
          SMARTCOMPONENTS__DEPLOYMENTNAME: ${{ secrets.SMARTCOMPONENTS__DEPLOYMENTNAME }}
          SMARTCOMPONENTS__ENDPOINT: ${{ secrets.SMARTCOMPONENTS__ENDPOINT }}
          
          # Downstream API
          DOWNSTREAMAPI__BASEURL: ${{ secrets.DOWNSTREAMAPI__BASEURL }}
          DOWNSTREAMAPI__SCOPES: ${{ secrets.DOWNSTREAMAPI__SCOPES }}
          
          # Azure OpenAI
          AZUREOPENAIENDPOINT03: ${{ secrets.AZUREOPENAIENDPOINT03 }}
          AZUREOPENAIKEY03: ${{ secrets.AZUREOPENAIKEY03 }}
          AZUREOPENAIMODELNAME02: ${{ secrets.AZUREOPENAIMODELNAME02 }}
          AZUREOPENAIMODELNAME03: ${{ secrets.AZUREOPENAIMODELNAME03 }}
          
          # Storage
          STORAGECONNECTIONSTRING: ${{ secrets.STORAGECONNECTIONSTRING }}
          STORAGECONTAINERNAME: ${{ secrets.STORAGECONTAINERNAME }}
          
          # Additional Azure Credentials
          CLIENTID: ${{ secrets.CLIENTID }}
          CLIENTSECRET: ${{ secrets.CLIENTSECRET }}
          TENANTID: ${{ secrets.TENANTID }}
          
          # Webfrontend Azure Credentials
          WEBFRONTEND_AZURE_CLIENT_ID: ${{ secrets.WEBFRONTEND_AZURE_CLIENT_ID }}
          WEBFRONTEND_AZURE_SUBSCRIPTION_ID: ${{ secrets.WEBFRONTEND_AZURE_SUBSCRIPTION_ID }}
          WEBFRONTEND_AZURE_TENANT_ID: ${{ secrets.WEBFRONTEND_AZURE_TENANT_ID }}

