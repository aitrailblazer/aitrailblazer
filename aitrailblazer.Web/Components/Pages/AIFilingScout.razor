@page "/"
@rendermode InteractiveServer


@using System.Text.RegularExpressions
@using System.Text.Json
@using Cosmos.Copilot.Services
@using AITrailblazer.net.Services
@using AITrailblazer.net.Models

@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Authorization
@using Microsoft.Identity.Web
@using AITGraph.Sdk.Models
@using System.Diagnostics;
@using Newtonsoft.Json;
@using System.Text.RegularExpressions
@using Microsoft.AspNetCore.Components.Authorization
@using Azure.AI.OpenAI;
@using SmartComponents
@using System.ComponentModel.DataAnnotations
@using GraphMessage = AITGraph.Sdk.Models.Message

@using Microsoft.AspNetCore.Components.Web
@using VectorStoreRAG
@inject ILogger<AIFilingScout> Logger
@inject IJSRuntime JSRuntime
@inject ChatService ChatService
@inject SECEdgarWSAppService SECEdgarWSAppService
@inject GotenbergWSAppService GotenbergWSAppService

@inject PluginService PluginService
@inject NavigationManager NavigationManager
@inject AITGraphService graphService
@inject IJSRuntime jsRuntime
@inject AzureOpenAIHandler azureOpenAIHandler
@inject TimeFunctions _timeFunctions
@inject UserIDsService UserIDsService
@inject RAGChatService<string> RagChatService

<PageTitle>Filing Scout AI</PageTitle>

@if (currentUserIdentityID == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <h3>Hello Message:</h3>
<p>@helloMessage</p>

    <FluentLayout Style="margin-top: 10px;">
        <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.Left" VerticalGap="2">

            <FluentCard Width="800px" Height="1200px" MinimalStyle="true">
                <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.Left" VerticalGap="2">
                    <FluentIcon Value="@(new Icons.Regular.Size24.SearchSparkle())" Color="@Color.Accent" />
                    <FluentLabel Typo="Typography.H4" Style="color: #347687;">EDGAR Filing Search</FluentLabel>
                </FluentStack>
                <!-- Input Section -->
                <FluentStack Orientation="Orientation.Vertical" VerticalGap="2"
                    Style="padding: 20px; border: 1px solid var(--neutral-outline-rest); border-radius: 8px; background-color: var(--neutral-fill-rest); text-align: center;">
                    <div class="textarea-container" style="width: 100%;">
                        <textarea @bind="Ticker" @oninput="HandleTickerInput" placeholder="Enter ticker symbol (e.g., AAPL, MSFT)"
                            maxlength="10" id="animatedTextarea"
                            style="width: 100%; padding: 12px; font-size: 16px; border: 1px solid #ccc; border-radius: 8px; transition: border-color 0.3s ease; resize: none;">
                        </textarea>
                    </div>

                    <!-- Display Results -->
                    @if (!string.IsNullOrEmpty(CIK))
                    {
                        <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.Left"
                            VerticalGap="2">
                            <FluentLabel Typo="Typography.Body">@Name |</FluentLabel>
                            <FluentLabel Typo="Typography.Body">@Ticker |</FluentLabel>
                            <FluentLabel Typo="Typography.Body">@Exchange |</FluentLabel>

                            <FluentLabel Typo="Typography.Body">CIK: @CIK</FluentLabel>
                        </FluentStack>
                    }
                    <FluentToolbar id="toolbar-slotted-label">
                        <!-- Button to Trigger the Menu -->

                        <FluentButton IconStart="@(new Icons.Filled.Size24.DocumentOnePage())" id="latestFilingsButton"
                            Appearance="Appearance.Neutral" @onclick="@(() => formOpen = !formOpen)"
                            disabled="@IsMenuButtonDisabled">
                            Latest Filings
                        </FluentButton>
                        <!-- Menu to Select Available Forms -->
                        @SelectedForm
                        <FluentMenu @bind-Open="@formOpen" @onmenuchange="OnFormMenuChange" Width="400px">
                            @if (AvailableForms != null && AvailableForms.Any())
                            {
                                @foreach (var form in AvailableForms)
                                {
                                    <FluentMenuItem Value="@form">@form</FluentMenuItem>
                                }
                            }
                            else
                            {
                                <FluentMenuItem Value="NoFormsAvailable" Disabled="true">No Forms Available</FluentMenuItem>
                            }
                        </FluentMenu>
                        <FluentButton IconStart="@(new Icons.Filled.Size24.DocumentOnePageMultiple())"
                            Appearance="Appearance.Neutral" @onclick="FetchFilings" disabled="@IsButtonDisabled">
                            All Filings
                        </FluentButton>
                        <!-- Button to Trigger the Menu -->
                        <FluentButton IconStart="@(new Icons.Filled.Size24.DataArea())" id="conceptMenuButton"
                            Appearance="Appearance.Neutral" @onclick="@(() => open = !open)" disabled="@IsButtonDisabled">
                            Financial Concept
                        </FluentButton>
                        <!-- Menu to Select Financial Concepts -->
                        <FluentMenu @bind-Open="@open" @onmenuchange="OnFinancialConceptMenuChange" Width="400px">
                            <FluentMenuItem Value="Assets">Assets</FluentMenuItem>
                            <FluentMenuItem Value="AssetsCurrent">AssetsCurrent</FluentMenuItem>
                            <FluentMenuItem Value="Liabilities">Liabilities</FluentMenuItem>
                            <FluentMenuItem Value="LiabilitiesCurrent">LiabilitiesCurrent</FluentMenuItem>
                            <FluentMenuItem Value="StockholdersEquity">StockholdersEquity</FluentMenuItem>
                            <FluentMenuItem Value="Revenues">Revenues</FluentMenuItem>
                            <FluentMenuItem Value="GrossProfit">GrossProfit</FluentMenuItem>
                            <FluentMenuItem Value="OperatingIncomeLoss">OperatingIncomeLoss</FluentMenuItem>
                            <FluentMenuItem Value="NetIncomeLoss">NetIncomeLoss</FluentMenuItem>
                            <FluentMenuItem Value="CashAndCashEquivalentsAtCarryingValue">
                                CashAndCashEquivalentsAtCarryingValue
                            </FluentMenuItem>
                            <FluentMenuItem Value="LongTermDebt">LongTermDebt</FluentMenuItem>
                            <FluentMenuItem Value="ResearchAndDevelopmentExpense">ResearchAndDevelopmentExpense
                            </FluentMenuItem>
                            <FluentMenuItem Value="SellingGeneralAndAdministrativeExpense">
                                SellingGeneralAndAdministrativeExpense</FluentMenuItem>
                        </FluentMenu>
                        <FluentButton IconStart="@(new Icons.Filled.Size24.LayerDiagonalSparkle())"
                            Appearance="Appearance.Neutral" @onclick="FetchFilings" disabled="@IsButtonDisabled">
                            Vectorize
                        </FluentButton>
                    </FluentToolbar>
                </FluentStack>

                <!-- Loading State -->
                @if (IsLoading)
                {
                    <FluentProgress Style="width: 100%; max-width: 300px; margin: 20px auto;" />
                    <p>Loading... Please wait.</p>
                }

                <!-- Error State -->
                @if (HasError)
                {
                    <FluentCard Style="padding: 15px; border-radius: 8px; background-color: var(--neutral-fill-rest);">
                        <strong style="color: red;">Error:</strong>
                        <p>@ErrorMessage</p>
                    </FluentCard>
                }

                <!-- Display Filings -->
                @if (Filings != null && Filings.Any())
                {
                    <FluentCard Width="800px" Height="1200px" MinimalStyle="true">
                        <div
                            style="max-height: 400px; overflow-y: auto; border: 1px solid var(--neutral-outline-rest); border-radius: 8px;">
                            <FluentAccordion>
                    @foreach (var group in Filings.GroupBy(f => f.Form))
                    {
                        <FluentAccordionItem Heading="@group.Key">
                            <FluentIcon Value="@(new Icons.Regular.Size20.DocumentOnePageSparkle())" Color="@Color.Neutral"
                                Slot="start" />
                            <table style="width:100%; border-collapse: collapse; margin-top: 10px;">
                                <thead>
                                    <tr style="background-color: var(--neutral-fill-hover);">
                                        <th style="padding: 10px; text-align:left;">Filing Date</th>
                                        <th style="padding: 10px; text-align:left;">Accession Number</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var filing in group)
                                    {
                                        <tr style="border-bottom: solid thin var(--neutral-outline-rest);">
                                            <td style="padding:10px;">@filing.FilingDate</td>
                                            <td style="padding:10px;">
                                                <a href="javascript:void(0);" @onclick="() => ShowPdfPreview(filing)" @onclick:preventDefault>
                                                    @filing.AccessionNumber
                                                </a>
                                            </td>
                                        </tr>
                                    }
                            </tbody>
                        </table>
                    </FluentAccordionItem>
                    }
                            </FluentAccordion>
                        </div>
                    </FluentCard>
                }
                <!-- Display PDF -->
                @if (!string.IsNullOrEmpty(PDFDataUrl))
                {
                    <FluentCard Width="800px" Height="1200px" MinimalStyle="true">
                        <object data="@PDFDataUrl" type="application/pdf" width="100%" height="500px">
                            <embed src="@PDFDataUrl" type="application/pdf" />
                        </object>
                    </FluentCard>
                }
                <!-- Display HTML -->
                @if (!string.IsNullOrEmpty(HTMLContent))
                {
                    <div id="contentContainer" style="width: 800px; height: 600px; overflow: auto;">
                        @((MarkupString)HTMLContent)
                    </div>
                }              
                @if (!string.IsNullOrEmpty(PlotHtml))
                {
                    <FluentCard Width="800px" Height="1200px" MinimalStyle="true">

                        <div>@((MarkupString)PlotHtml)</div>
                    </FluentCard>
                }
            </FluentCard>
            <FluentCard Width="800px" Height="1200px" MinimalStyle="true">
                <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.Left" VerticalGap="2">
                    <FluentIcon Value="@(new Icons.Regular.Size24.ChatSparkle())" Color="@Color.Accent" />
                    <FluentLabel Typo="Typography.H4" Style="color: #347687;">AI Insights</FluentLabel>
                </FluentStack>
                @if (Submitting)
                {
                    <!-- Loading State -->
                    <FluentStack Orientation="Orientation.Vertical" HorizontalAlignment="HorizontalAlignment.Left" VerticalGap="2">
                        <FluentLabel Typo="Typography.Body" Style="font-size: 16px; color: #555;">Please wait...</FluentLabel>
                        <FluentProgress Style="width: 100%; max-width: 300px; margin: 20px 0;" />
                        <div id="currentLineContainer"
                            style="margin-top: 20px; padding: 15px; border: 1px solid var(--neutral-outline-rest); background-color: var(--neutral-fill-rest); font-size: 16px; border-radius: 8px;">
                            <strong style="color: #0078D4;">@CurrentLine</strong>
                        </div>
                    </FluentStack>
                }
                else
                {
                    <!-- Input Section -->
                    <FluentStack Orientation="Orientation.Vertical" VerticalGap="2"
                        Style="padding: 20px; border: 1px solid var(--neutral-outline-rest); border-radius: 8px; background-color: var(--neutral-fill-rest); text-align: center;">
                        <div class="textarea-container" style="width: 100%;">
                            <textarea @bind="PromptText" @oninput="HandleInput" placeholder="Enter your prompt..." maxlength="500"
                                id="animatedTextarea"
                                style="width: 100%; padding: 12px; font-size: 16px; border: 1px solid #ccc; border-radius: 8px; resize: vertical; transition: border-color 0.3s ease;">
                                </textarea>
                            <div class="char-counter" style="text-align: right; font-size: 14px; color: #555; margin-top: 5px;">
                                @($"{PromptText.Length}/500 characters")
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <FluentButton IconStart="@(new Icons.Filled.Size32.ArrowCircleUp())" Appearance="Appearance.Neutral"
                            @onclick="FetchCompletion" disabled="@IsPromptButtonDisabled" Style="margin: 15px auto; display: block;">
                            Submit
                        </FluentButton>
                    </FluentStack>
                }

                <!-- Finalized Results Section -->
                                @if (FinalizedGroups.Any())
                                {
                                    <FluentCard
                                        Style="padding: 20px; max-width: 900px; margin: 40px auto; border-radius: 12px; box-shadow: 0px 4px 8px rgba(0,0,0,0.1);">
                                        <div style="max-height: 400px; overflow-y: auto; padding: 10px;">
                                            <FluentAccordion>
                                    @foreach (var (title, contentLines) in FinalizedGroups)
                                    {
                                                                                <FluentAccordionItem Heading="@title">
                                                                                    <FluentIcon Value="@(new Icons.Regular.Size20.DocumentOnePageSparkle())" Color="@Color.Neutral"
                                                                                        Slot="start" />
                                            @foreach (var content in contentLines)
                                            {
                                                                                                                    <div
                                                                                                                        style="margin-bottom: 15px; padding: 10px; border: 1px solid var(--neutral-outline-hover); border-radius: 8px; background-color: var(--neutral-fill-rest); box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); font-size: 14px; line-height: 1.5; text-align: left;">
                                                    @(new MarkupString(ParseLineToStyledHtml(content)))
                                                                                                                    </div>
                                            }
                                                                                </FluentAccordionItem>
                                    }
                                            </FluentAccordion>
                                        </div>
                                    </FluentCard>
                                }

                    </FluentCard>
        </FluentStack>

    </FluentLayout>
}
@code {
    private string TenantId = "1234";
    private string UserId = "5678";
    private string CategoryId = "Document";
    private string PromptText = string.Empty;
    private double SimilarityScore = 0.7;

    private List<(string Title, List<string> ContentLines)> FinalizedGroups = new();
    private string CurrentLine = string.Empty;
    private bool Submitting = false;
    private string CurrentTitle = "Untitled";

    private bool IsPromptButtonDisabled => string.IsNullOrEmpty(PromptText) || PromptText.Length < 10;

    protected override void OnInitialized()
    {
        ChatService.StatusUpdated += async (message) => await OnStatusUpdated(message);
    }

    private async Task OnStatusUpdated(string message)
    {
        Logger.LogInformation($"OnStatusUpdated received message: {message}");

        if (message.StartsWith("Finalized Line:"))
        {
            // Extract the finalized line (e.g., content)
            var finalizedLine = message.Replace("Finalized Line:", "").Trim();

            // Check if the finalized line contains a new title
            if (finalizedLine.StartsWith("**Title**:"))
            {
                // Extract the new title
                var match = Regex.Match(finalizedLine, @"\*\*Title\*\*: (.*?)\n");
                if (match.Success)
                {
                    CurrentTitle = match.Groups[1].Value.Trim();

                    // Add a new group for the new title
                    FinalizedGroups.Add((CurrentTitle, new List<string>()));
                }
            }
            else
            {
                // Add the content line to the most recent group
                if (FinalizedGroups.Any())
                {
                    FinalizedGroups.Last().ContentLines.Add(finalizedLine);
                }
                else
                {
                    // If no group exists, create one with the default title
                    FinalizedGroups.Add((CurrentTitle, new List<string> { finalizedLine }));
                }
            }

            StateHasChanged();
            await JSRuntime.InvokeVoidAsync("scrollToBottom", "statusMessagesContainer");
        }
        else
        {
            // Handle streaming lines
            CurrentLine = message.Trim();
            StateHasChanged();
        }
    }

    private async Task FetchCompletion(MouseEventArgs e)
    {
        if (IsPromptButtonDisabled)
        {
            Logger.LogWarning("PromptText is empty or too short.");
            return;
        }

        Submitting = true;
        FinalizedGroups.Clear();
        CurrentLine = string.Empty;

        try
        {
            // Fetch completion and title from the service
            var (completion, title) = await ChatService.GetKnowledgeBaseStreamingCompletionAsync(
            TenantId, UserId, CategoryId, PromptText, SimilarityScore);

            // Add the final title and completion
            //FinalizedGroups.Add((title, new List<string> { completion }));
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error fetching completion");
            FinalizedGroups.Add(("Error", new List<string> { "An error occurred while fetching the completion." }));
        }
        finally
        {
            Submitting = false;
        }
    }

    private string ParseLineToStyledHtml(string line)
    {
        line = Regex.Replace(line, @"\*\*Title\*\*: (.*?)\n",
        @"<h4 style='color: #0078D4; font-size: 18px;'><strong>Title:</strong> $1</h4>");

        line = line.Replace("**Content Summary**:",
        "<h5 style='color: #555; font-size: 16px;'><strong>Content Summary:</strong></h5>")
        .Replace("Reference Link:",
        "<h5 style='color: #555; font-size: 16px;'><strong>Reference Link:</strong></h5>");

        line = Regex.Replace(line, @"\[(.*?)\]\((.*?)\)",
        @"<a href='$2' target='_blank' style='color: #0078D4;'>$1</a>");

        return line.Replace("\n", "<p style='margin: 5px 0;'>");
    }

    private async void HandleInput(ChangeEventArgs e)
    {
        PromptText = e.Value?.ToString() ?? string.Empty;
        await JSRuntime.InvokeVoidAsync("adjustTextAreaHeight", "animatedTextarea");
        StateHasChanged();
    }
}
@code {
    private string error;

    private string Ticker = string.Empty;
    private bool IsLoading = false;
    private bool HasError = false;
    private string ErrorMessage = string.Empty;
    private List<Filing>? Filings = null;

    private string? CIK;
    private string? Name;
    private string? Exchange;

    private string? FilingsJson;
    private string? PDFDataUrl;
    // Property to store the HTML content
    private string? HTMLContent { get; set; }

    // Computed property to disable buttons
    private bool IsButtonDisabled => string.IsNullOrEmpty(Ticker) || Ticker.Length < 1;

    /// <summary>
    /// Handles input changes in the ticker input field.
    /// Dynamically updates the state of the buttons.
    /// </summary>
    private async Task HandleTickerInput(ChangeEventArgs e)
    {
        Ticker = e.Value?.ToString() ?? string.Empty;
        if (!string.IsNullOrEmpty(Ticker))
        {
            await FetchAvailableForms(); // Await the async call
        }
        StateHasChanged(); // Trigger UI update
    }


    /// <summary>
    /// Fetches the CIK for the given ticker.
    /// </summary>
    private async Task FetchCIK()
    {
        try
        {
            IsLoading = true;
            HasError = false;
            ErrorMessage = string.Empty;

            CIK = await SECEdgarWSAppService.GetCIKAsync(Ticker);
            FilingsJson = null; // Clear filings data when fetching new CIK
            Filings = null;
            PDFDataUrl = null; // Clear PDF preview when fetching new CIK
            HTMLContent = null; // Clear HTML preview when fetching new CIK
        }
        catch (Exception ex)
        {
            HasError = true;
            ErrorMessage = $"An error occurred while fetching CIK for {Ticker}: {ex.Message}";
            CIK = null;
        }
        finally
        {
            IsLoading = false;
        }
    }
    private async Task ShowPdfPreview1(Filing filing)
    {
        try
        {
            IsLoading = true;
            string filingUrl = ConstructFilingUrl(CIK, filing.AccessionNumber, filing.PrimaryDocument);
            Console.WriteLine($"filingUrl: {filingUrl}");
            byte[] pdfBytes = await GotenbergWSAppService.ConvertUrlToPdfAsync(filingUrl, userEmail); // Assuming userEmail is available
            //filing.PdfDataUrl = $"data:application/pdf;base64,{Convert.ToBase64String(pdfBytes)}";
            PDFDataUrl = $"data:application/pdf;base64,{Convert.ToBase64String(pdfBytes)}";

            FilingsJson = null; // Clear filings data when fetching new CIK
            Filings = null;
            StateHasChanged(); // Force component to re-render with updated PDF data
        }
        catch (Exception ex)
        {
            // Handle the error (e.g., log it or show an error message to the user)
            Console.WriteLine($"Error converting URL to PDF: {ex.Message}");
            PDFDataUrl = null; // Clear PDF preview on error
        }
        finally
        {
            IsLoading = false;
        }
    }
//   https://www.sec.gov/Archives/edgar/data/0001318605/000177134025000001/xslF345X05/edgardoc.xml
    private async Task ShowPdfPreview(Filing filing)
    {
        try
        {
            IsLoading = true;
            FilingsJson = null; // Clear previous filings data
            Filings = null; // Clear previous filings

            // Log the start of the process
            Console.WriteLine("Starting PDF preview generation...");

            // Ensure the CIK is padded to 10 digits (SEC EDGAR requirement)
            var paddedCik = CIK?.PadLeft(10, '0');
            if (string.IsNullOrWhiteSpace(paddedCik))
            {
                Console.WriteLine("Error: CIK is null or empty.");
                PDFDataUrl = null; // Clear PDF preview on error
                return;
            }

            // Validate filing data
            if (string.IsNullOrWhiteSpace(filing.AccessionNumber))
            {
                Console.WriteLine("Error: Accession number is null or empty.");
                PDFDataUrl = null; // Clear PDF preview on error
                return;
            }
            if (string.IsNullOrWhiteSpace(filing.PrimaryDocument))
            {
                Console.WriteLine("Error: Primary document is null or empty.");
                PDFDataUrl = null; // Clear PDF preview on error
                return;
            }

            Console.WriteLine($"Fetching HTML content for CIK: {paddedCik}, Accession Number: {filing.AccessionNumber}, Primary Document: {filing.PrimaryDocument}");
            string filingUrl = ConstructFilingUrl(paddedCik, filing.AccessionNumber, filing.PrimaryDocument);
            Console.WriteLine($"filingUrl: {filingUrl}");
            //var accessionNumberWithoutDashes = filing.AccessionNumber.Replace("-", "");

            // Fetch the HTML content
            var htmlContent = await SECEdgarWSAppService.DownloadHtmlContentAsync(paddedCik, filing.AccessionNumber, filing.PrimaryDocument);
            //Logger.LogInformation($"htmlContent: {htmlContent}");
            HTMLContent = htmlContent;
            PDFDataUrl = null;
            HTMLContent = htmlContent;
            string filePath = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.Desktop), $"{Ticker}_{SelectedForm}_Test.html");
            await File.WriteAllTextAsync(filePath, HTMLContent);
            Console.WriteLine($"HTML saved to: {filePath}");

            Console.WriteLine("Successfully fetched HTML content. Converting to PDF...");

            // Convert HTML to PDF and store as byte array
            //var pdfBytes = await GoSECEdgarWSAppService.ConvertHtmlToPdfAsync(htmlContent);
            //PDFDataUrl = $"data:application/pdf;base64,{Convert.ToBase64String(pdfBytes)}";

         }
        catch (Exception ex)
        {
            // Log unexpected errors and clear the PDF preview
            Console.WriteLine($"Unexpected error: {ex.Message}");
            PDFDataUrl = null;
        }
        finally
        {
            IsLoading = false;
            StateHasChanged(); // Force component to re-render with the updated state
            Console.WriteLine("PDF preview generation process completed.");
        }
    }
    /// <summary>
    /// Fetches the filing history for the given ticker.
    /// </summary>
    private async Task FetchFilings()
    {
        try
        {
            IsLoading = true;
            HasError = false;
            ErrorMessage = string.Empty;

            // Fetch the CIK for the provided ticker
            CIK = await SECEdgarWSAppService.GetCIKAsync(Ticker);

            if (string.IsNullOrWhiteSpace(CIK))
            {
                Console.WriteLine($"No CIK found for ticker {Ticker}. Skipping filings fetch.");
                Filings = new List<Filing>(); // Initialize with an empty list
                return;
            }

            // Fetch filings JSON from the service
            FilingsJson = await SECEdgarWSAppService.GetFilingsAsync(Ticker);
            //Console.WriteLine($"FilingsJson: {FilingsJson}");

            // Deserialize JSON into a list of Filing objects using Newtonsoft.Json
            if (!string.IsNullOrEmpty(FilingsJson))
            {
                try
                {
                    Filings = Newtonsoft.Json.JsonConvert.DeserializeObject<List<Filing>>(FilingsJson) ?? new List<Filing>();
                }
                catch (Newtonsoft.Json.JsonException jsonEx)
                {
                    Console.WriteLine($"Error deserializing FilingsJson: {jsonEx.Message}");
                    Filings = new List<Filing>(); // Fallback to an empty list if deserialization fails
                }
            }
            else
            {
                Console.WriteLine($"FilingsJson is empty or null for ticker {Ticker}.");
                Filings = new List<Filing>(); // Initialize with an empty list
            }
        }
        catch (HttpRequestException httpEx)
        {
            HasError = true;
            ErrorMessage = $"Network error while fetching filings for {Ticker}. Please try again later.";
            Console.WriteLine($"HTTP error: {httpEx.Message}");
        }
        catch (Exception ex)
        {
            HasError = true;
            ErrorMessage = $"An unexpected error occurred while fetching filings for {Ticker}: {ex.Message}";
            Console.WriteLine($"Unexpected error: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
            StateHasChanged(); // Update the UI
        }
    }

    public class Filing
    {
        public string Form { get; set; } = string.Empty;
        public string FilingDate { get; set; } = string.Empty;
        public string AccessionNumber { get; set; } = string.Empty;
        public string CIK { get; set; } = string.Empty;
        public string PrimaryDocument { get; set; } = string.Empty;
        public string? PdfDataUrl { get; set; } // New property for PDF data URL
    }

    // GotenbergWSAppService.ConvertUrlToPdfAsync
    private string ConstructFilingUrl(string cik, string accessionNumber, string primaryDocument)
    {
        // Ensure the CIK is padded to 10 digits (SEC EDGAR requirement)
        var paddedCik = cik.PadLeft(10, '0');

        // Remove dashes from the accession number
        var accessionNumberWithoutDashes = accessionNumber.Replace("-", "");

        // Construct the SEC EDGAR URL
        return $"https://www.sec.gov/Archives/edgar/data/{paddedCik}/{accessionNumberWithoutDashes}/{primaryDocument}";
    }
}
@code {
    private bool isLoading = true;

    private bool isInitialized = false;
    private string timeZoneInfo;

    private string userTimeZone;
    private DateTime userLocalTime;
    private string currentUserTenantID;
    private string currentUserIdentityID;
    private Profile profile;
    private string? userPhotoBase64;


    private UserAccountInformation accountInfo;
    private string? displayName;
    private string? Tenant;

    private string userEmail = "konstantine@aitrailblazer.com";
    private string userFullName;
    private string userPhoneNumer;
    private string userLanguage;
    private string userAddress;


    protected override async Task OnInitializedAsync()
    {
        if (!isInitialized)
        {
            // helloMessage = await HelloWorldApiClient.GetHelloAsync();

            await LoadUserDataAsync();
            isInitialized = true;
        }
    }
        private async Task LoadUserDataAsync()
    {
        isLoading = true;  // Show loading state
        error = null;
        //emailsWithComputedProperties.Clear();  // Clear previous data

        try
        {
     
            // Trigger re-render to show the result
            profile = await graphService.GetCurrentUserProfileAsync();
            accountInfo = await graphService.GetUserAccountInformationAsync();
            
            var (userId, tenantId) = await UserIDsService.GetUserIDsAsync();
            currentUserIdentityID = userId;
            currentUserTenantID = tenantId;
            
            userTimeZone = await UserIDsService.GetTimeZoneAsync();
            //Console.WriteLine($"LoadUserDataAsync userTimeZone: {userTimeZone}");

            timeZoneInfo = _timeFunctions.GetUserTimeZone();
            //Console.WriteLine($"LoadUserDataAsync timeZoneInfo: {timeZoneInfo}");
            
            // Get the current UTC time
            DateTime utcNow = DateTime.UtcNow;

            // Convert to user's local time
            userLocalTime = await UserIDsService.ConvertToUserTimeZoneAsync(utcNow);
            
            userLanguage = GetUserLanguage();

            userEmail = GetUserEmail();
            userFullName = GetUserFullName();  
            //displayName = userFullName;

            //userPhoneNumer = GetUserPhoneNumber();

            //userLanguage = GetUserLanguage();

            //userAddress = GetUserAddress();

            
            // Fetch the user's profile photo
            var photoStream = await graphService.GetUserPhotoAsync();
            if (photoStream != null)
            {
                using (var memoryStream = new MemoryStream())
                {
                    await photoStream.CopyToAsync(memoryStream);
                    userPhotoBase64 = Convert.ToBase64String(memoryStream.ToArray());
                }
            }

  
            var mailboxSettings = await graphService.GetMailboxSettingsAsync();
            if (mailboxSettings != null)
            {
                //($"Time Zone: {mailboxSettings.TimeZone}");
                //Console.WriteLine($"Date Format: {mailboxSettings.DateFormat}");
                //Console.WriteLine($"Time Format: {mailboxSettings.TimeFormat}");
                
                // Accessing other properties
                //Console.WriteLine($"Archive Folder: {mailboxSettings.ArchiveFolder}");
                
                if (mailboxSettings.AutomaticRepliesSetting != null)
                {
                    //Console.WriteLine($"Automatic Replies Status: {mailboxSettings.AutomaticRepliesSetting.Status}");
                    //Console.WriteLine($"External Audience: {mailboxSettings.AutomaticRepliesSetting.ExternalAudience}");
                    // Add more properties as needed
                }
                
                if (mailboxSettings.Language != null)
                {
                    //Console.WriteLine($"Language Locale: {mailboxSettings.Language.Locale}");
                    //Console.WriteLine($"Language Display Name: {mailboxSettings.Language.DisplayName}");
                }
                
                if (mailboxSettings.WorkingHours != null)
                {
                    //Console.WriteLine($"Working Hours Start Time: {mailboxSettings.WorkingHours.StartTime}");
                    //Console.WriteLine($"Working Hours End Time: {mailboxSettings.WorkingHours.EndTime}");
                    //Console.WriteLine($"Working Days: {string.Join(", ", mailboxSettings.WorkingHours.DaysOfWeek)}");
                }
                
                //Console.WriteLine($"User Purpose: {mailboxSettings.UserPurpose}");
                //Console.WriteLine($"User Purpose V2: {mailboxSettings.UserPurposeV2}");
                //Console.WriteLine($"Delegate Meeting Message Delivery Options: {mailboxSettings.DelegateMeetingMessageDeliveryOptions}");
            }
        }
        catch (AuthenticationRequiredException)
        {
            RedirectToLogin();
        }
        catch (Exception ex)
        {
            error = $"Error loading user data: {ex.Message}";
        }
        finally
        {
            isLoading = false;  // Hide loading state
        }
    }
    private string GetUserLanguage()
    {
        // Try to get the user's primary language from the Languages list
        if (profile?.Languages != null && profile.Languages.Any())
        {
            var primaryLanguage = profile.Languages.FirstOrDefault();
            if (primaryLanguage != null)
            {
                string displayName = primaryLanguage.DisplayName ?? "";
                string tag = primaryLanguage.Tag ?? "";

                if (!string.IsNullOrWhiteSpace(displayName))
                {
                    return displayName;
                }
                else if (!string.IsNullOrWhiteSpace(tag))
                {
                    return tag;
                }
            }
        }

        // As a fallback, return a default message or an empty string
        return "Language not specified";
    }

     private string GetUserAddress()
    {
        // Try to get the user's current position from the Positions list
        if (profile?.Positions != null && profile.Positions.Any())
        {
            // Look for the current position where IsCurrent is true
            var currentPosition = profile.Positions.FirstOrDefault(position => position.IsCurrent == true);

            if (currentPosition != null && currentPosition.Detail?.Company?.Address != null)
            {
                var address = currentPosition.Detail.Company.Address;

                // Extract address components
                string street = address.Street ?? "";
                string city = address.City ?? "";
                string state = address.State ?? "";
                string postalCode = address.PostalCode ?? "";
                string countryOrRegion = address.CountryOrRegion ?? "";

                // Build the full address string
                var addressParts = new List<string> { street, city, state, postalCode, countryOrRegion };
                var fullAddress = string.Join(", ", addressParts.Where(part => !string.IsNullOrWhiteSpace(part)));

                if (!string.IsNullOrWhiteSpace(fullAddress))
                {
                    return fullAddress;
                }
            }
        }

        // As a fallback, return a default message or an empty string
        return "Address not specified";
    }
        private string GetUserEmail()
    {
        // Try to get the user's primary email from the Emails list
        if (profile?.Emails != null && profile.Emails.Any())
        {
            var primaryEmail = profile.Emails.FirstOrDefault();
            if (primaryEmail != null)
            {
                return primaryEmail.Address ?? accountInfo?.UserPrincipalName ?? "";
            }
        }
        // As a fallback, return accountInfo?.UserPrincipalName or an empty string
        return accountInfo?.UserPrincipalName ?? "";
    }
    
    private string GetUserFullName()
    {
        // Try to get the user's full name from the Names list
        if (profile?.Names != null && profile.Names.Any())
        {
            var primaryName = profile.Names.FirstOrDefault();
            if (primaryName != null)
            {
                string firstName = primaryName.First ?? "";
                string lastName = primaryName.Last ?? "";
                if (!string.IsNullOrWhiteSpace(firstName) || !string.IsNullOrWhiteSpace(lastName))
                {
                    return $"{firstName} {lastName}".Trim();
                }
                else if (!string.IsNullOrWhiteSpace(primaryName.DisplayName))
                {
                    return primaryName.DisplayName;
                }
            }
        }

        // As a fallback, return accountInfo?.UserPrincipalName or "User"
        return accountInfo?.UserPrincipalName ?? "User";
    }
      private string GetUserPhoneNumber()
    {
        // Try to get the user's primary phone number from the Phones list
        if (profile?.Phones != null && profile.Phones.Any())
        {
            // Look for the mobile phone number first
            var mobilePhone = profile.Phones.FirstOrDefault(phone => phone.Type == PhoneType.Mobile);
            if (mobilePhone != null && !string.IsNullOrWhiteSpace(mobilePhone.Number))
            {
                return mobilePhone.Number;
            }

            // If no mobile phone, get any available phone number
            var primaryPhone = profile.Phones.FirstOrDefault();
            if (primaryPhone != null && !string.IsNullOrWhiteSpace(primaryPhone.Number))
            {
                return primaryPhone.Number;
            }
        }

        // As a fallback, return an empty string or a default message
        return "";
    }

    private void RedirectToLogin()
    {
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        var queryString = System.Web.HttpUtility.ParseQueryString(uri.Query);
        // Get the value of the "myParameter" query string parameter
        Tenant = queryString["Tenant"];
        //Console.WriteLine($"Tenant: {Tenant}");
   
        // Log the returnUrl for debugging purposes
        //Console.WriteLine($"uri: {uri}");

        // Navigate to the sign-in page with the encoded returnUrl
        NavigationManager.NavigateTo($"/MicrosoftIdentity/Account/SignIn?returnUrl={uri}", forceLoad: true);
    }
    private bool open = false;
    private string SelectedConcept { get; set; } = "";

    private async Task OnFinancialConceptMenuChange(MenuChangeEventArgs args)
    {
        if (args is not null && args.Value is not null)
        {
            SelectedConcept = args.Value;
            Logger.LogInformation($"Selected concept: {SelectedConcept}");
            await FetchXBRLPlot();
        }
    }
}

@code {
    //private string Concept { get; set; } = "AssetsCurrent";
    private string Unit { get; set; } = "USD";
    private string? PlotHtml { get; set; }


    private async Task FetchXBRLPlot()
    {
        try
        {
            IsLoading = true;
            HasError = false;
            ErrorMessage = string.Empty;

            // Clear previous data
            FilingsJson = null; // Clear filings data when fetching new CIK
            Filings = null;
            PDFDataUrl = null; // Clear PDF preview when fetching new CIK
            PlotHtml = null;   // Clear previous plot HTML

            // Fetch Plot HTML
            PlotHtml = await SECEdgarWSAppService.GetPlotHtmlWithFallbackAsync(Ticker, SelectedConcept, Unit);

            // Fetch CSV data
            //var XBRLCsvStream = await SECEdgarWSAppService.GetXBRLCsvAsync(Ticker, SelectedConcept, Unit);

            // Save CSV to a file
            //string fileName = $"{Ticker}_{SelectedConcept}_Test.csv";
            //string filePath = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.Desktop), fileName);

            //using (var fileStream = new FileStream(filePath, FileMode.Create, FileAccess.Write, FileShare.None))
            //{
            //    await XBRLCsvStream.CopyToAsync(fileStream);
            //}

            //Console.WriteLine($"CSV saved to: {filePath}");
        }
        catch (Exception ex)
        {
            HasError = true;
            ErrorMessage = $"An error occurred while fetching the plot: {ex.Message}";
            PlotHtml = null;
        }
        finally
        {
            IsLoading = false;
        }
    }
}


@code {

    private List<string> AvailableForms = new();
    private string SelectedForm { get; set; } = string.Empty;
    private bool formOpen = false;

    private bool IsMenuButtonDisabled => string.IsNullOrEmpty(Ticker) || IsLoading;

     private async Task FetchAvailableForms()
    {
        try
        {
            IsLoading = true;
            HasError = false;
            ErrorMessage = string.Empty;

            // Validate ticker format
            if (string.IsNullOrWhiteSpace(Ticker) || !Regex.IsMatch(Ticker, @"^[A-Za-z0-9]+$"))
            {
                Logger.LogWarning("Invalid ticker format provided. Skipping processing.");
                return;
            }

            // Fetch the CIK for the ticker
            CIK = await SECEdgarWSAppService.GetCIKAsync(Ticker);

            // If CIK is not found, log the info and stop processing
            if (string.IsNullOrEmpty(CIK))
            {
                Logger.LogInformation($"No CIK found for ticker {Ticker}. Skipping further processing.");
                return;
            }

            // Fetch the company name
            Name = await SECEdgarWSAppService.GetNameAsync(Ticker);

            // If no name is found, log the info but continue
            if (string.IsNullOrEmpty(Name))
            {
                Logger.LogInformation($"No company name found for ticker {Ticker}. Skipping further processing.");
                return;
            }

            Exchange = await SECEdgarWSAppService.GetExchangeAsync(Ticker);

            // If no name is found, log the info but continue
            if (string.IsNullOrEmpty(Exchange))
            {
                Logger.LogInformation($"No Exchange found for ticker {Ticker}. Skipping further processing.");
                return;
            }

            // Fetch available forms
            var forms = await SECEdgarWSAppService.GetAvailableFormsAsync(Ticker);

            // Process and filter forms
            AvailableForms = forms?
                .Select(f => f.Trim())
                .Where(f => !string.IsNullOrWhiteSpace(f))
                .Distinct()
                .OrderBy(f => f)
                .ToList() ?? new List<string>();

            // Log available forms
            if (AvailableForms.Any())
            {
                Logger.LogInformation($"Available forms for ticker {Ticker}: {string.Join(", ", AvailableForms)}");
            }
            else
            {
                Logger.LogInformation($"No forms available for ticker {Ticker}. Forms list will remain empty.");
            }
        }
        catch (HttpRequestException httpEx)
        {
            Logger.LogWarning(httpEx, $"Network issue while fetching data for ticker {Ticker}. Skipping processing.");
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, $"Unexpected issue occurred while fetching data for ticker {Ticker}. Skipping processing.");
        }
        finally
        {
            IsLoading = false;
            StateHasChanged(); // Trigger UI update
        }
    }

    /*The U.S. Securities and Exchange Commission (SEC) requires companies to submit various forms to ensure transparency
    and protect investors. Here's a summary of some common SEC forms:

                                - **Form 10-K**: An annual report providing a comprehensive overview of a company's financial condition, including
                                audited financial statements.

                                - **Form 10-Q**: A quarterly report detailing a company's financial performance over three months, offering unaudited
                                financial statements and updates on operations.

                                - **Form 8-K**: A report filed to announce significant events that shareholders should know about, such as acquisitions,
                                bankruptcies, or changes in executive leadership.

                                - **Form 4**: Filed by insiders to disclose changes in their ownership of a company's securities, ensuring transparency
                                in insider trading activities.

                                - **Form 3**: The initial filing by an insider to report their ownership of company securities when they first become an
                                insider.

                                - **Form 5**: An annual report filed by insiders to disclose transactions that were not reported earlier on Forms 3 or
                                4.

                                - **Form S-3**: A simplified registration form for companies to register securities offerings, often used for secondary
                                offerings.

                                - **Form S-4**: Filed by companies to register securities issued in certain business combination transactions, such as
                                mergers or acquisitions.

                                - **Form S-8**: Used to register securities offered to employees through benefit or incentive plans.

                                - **Schedule 13D**: Filed by anyone who acquires beneficial ownership of more than 5% of a voting class of a company's
                                equity securities, detailing the purpose of the acquisition.

                                - **Schedule 13G**: A shorter version of Schedule 13D, filed by certain passive investors owning more than 5% but
                                without intent to influence control.

                                - **Form DEF 14A**: A definitive proxy statement sent to shareholders, providing information on matters to be discussed
                                at a shareholder meeting.

                                - **Form 144**: Filed by affiliates intending to sell restricted or control securities, notifying the SEC of the
                                proposed sale.

                                - **Form SD**: Filed to disclose the use of conflict minerals originating in the Democratic Republic of the Congo or
                                adjoining countries.

                                These forms are essential tools for investors to assess a company's financial health, operations, and potential risks.
                                For more detailed information, you can refer to the SEC's official guide on using EDGAR to research investments.
                                */
    private async Task OnFormMenuChange(MenuChangeEventArgs args)
    {
        if (args?.Value is not null)
        {
            SelectedForm = args.Value;
            Logger.LogInformation($"Selected form: {SelectedForm}");
            await DownloadSelectedFormPdf();
        }
    }
    private async Task DownloadSelectedFormPdf()
    {
        try
        {
            IsLoading = true;
            HasError = false;
            ErrorMessage = string.Empty;

            // Fetch HTML content as a string
            var htmlContent = await SECEdgarWSAppService.DownloadLatestFilingHtmlAsync(Ticker, SelectedForm);
            //Logger.LogInformation($"htmlContent: {htmlContent}");
            HTMLContent = htmlContent;
            string filePath = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.Desktop), $"{Ticker}_{SelectedForm}_Test.html");
            await File.WriteAllTextAsync(filePath, HTMLContent);
            Console.WriteLine($"HTML saved to: {filePath}");

            PDFDataUrl = null;
            // Convert HTML to PDF using the new method that expects Gotenberg to handle pagination
            //var pdfBytes = await GotenbergWSAppService.ConvertFullHtmlToPdfAsync(htmlContent);
            // Save PDF locally for testing
            //string filePath = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.Desktop), $"{Ticker}_{SelectedForm}_Test.pdf");
            //await File.WriteAllBytesAsync(filePath, pdfBytes);

            //Console.WriteLine($"PDF saved to: {filePath}");
            //PDFDataUrl = $"data:application/pdf;base64,{Convert.ToBase64String(pdfBytes)}";

            //Console.WriteLine("HTML successfully downloaded and converted to PDF.");
            CIK = await SECEdgarWSAppService.GetCIKAsync(Ticker);

            FilingsJson = null; // Clear filings data when fetching new CIK
            Filings = null;
        }
        catch (Exception ex)
        {
            HasError = true;
            ErrorMessage = $"An error occurred while downloading and converting the HTML for {Ticker}: {ex.Message}";
            PDFDataUrl = null;
            PlotHtml = null;
        }
        finally
        {
            IsLoading = false;
        }
    }
}
@code
{
    Orientation orientation = Orientation.Horizontal;

    private void OnResizedHandler(SplitterResizedEventArgs args)
    {
    }
}

@code {
    private string helloMessage = string.Empty;


}

@code {
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !string.IsNullOrEmpty(HTMLContent))
        {
            await JSRuntime.InvokeVoidAsync("initializeAnchorNavigation", "contentContainer");
        }
    }
}